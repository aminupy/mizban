name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version label for dry-run artifacts (for example: 2.1.0-rc1)'
        required: true
        default: '0.0.0-dev'

permissions:
  contents: write

jobs:
  prepare:
    name: Prepare Metadata
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      tag: ${{ steps.meta.outputs.tag }}
      is_release: ${{ steps.meta.outputs.is_release }}
    steps:
      - name: Resolve version and mode
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "push" && "${GITHUB_REF}" == refs/tags/v* ]]; then
            TAG="${GITHUB_REF_NAME}"
            VERSION="${TAG#v}"
            IS_RELEASE="true"
          else
            VERSION="${{ github.event.inputs.version }}"
            VERSION="${VERSION#v}"
            TAG="v${VERSION}"
            IS_RELEASE="false"
          fi

          if [[ -z "${VERSION}" ]]; then
            echo "Version cannot be empty." >&2
            exit 1
          fi

          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "is_release=${IS_RELEASE}" >> "${GITHUB_OUTPUT}"

          echo "Mode: ${IS_RELEASE}"
          echo "Version: ${VERSION}"
          echo "Tag: ${TAG}"

  build_linux_windows:
    name: Build Linux + Windows Assets
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Prepare Windows icon resources
        shell: bash
        run: |
          set -euo pipefail
          go install github.com/akavel/rsrc@latest
          echo "$(go env GOPATH)/bin" >> "${GITHUB_PATH}"
          export PATH="$(go env GOPATH)/bin:${PATH}"
          ./packaging/windows/generate_icon_syso.sh

      - name: Build binaries
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"
          make VERSION="${VERSION}" build PLATFORMS="linux/amd64 linux/arm64 windows/amd64 windows/arm64"

      - name: Build DEB packages
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"
          make VERSION="${VERSION}" package-linux ARCHES="amd64 arm64"

      - name: Collect Linux + Windows assets
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"
          mkdir -p out

          # Portable bundles (binary + web assets) - runnable out of the box.
          tar -C dist -czf "out/mizban-${VERSION}-linux-amd64.tar.gz" "linux-amd64"
          tar -C dist -czf "out/mizban-${VERSION}-linux-arm64.tar.gz" "linux-arm64"
          tar -C dist -czf "out/mizban-${VERSION}-windows-amd64.tar.gz" "windows-amd64"
          tar -C dist -czf "out/mizban-${VERSION}-windows-arm64.tar.gz" "windows-arm64"

          # Raw binaries (embedded web fallback is available; --web-dir still supported).
          cp dist/linux-amd64/mizban "out/mizban-${VERSION}-linux-amd64"
          cp dist/linux-arm64/mizban "out/mizban-${VERSION}-linux-arm64"

          cp dist/windows-amd64/mizban.exe "out/mizban-${VERSION}-windows-amd64.exe"
          cp dist/windows-arm64/mizban.exe "out/mizban-${VERSION}-windows-arm64.exe"

          cp dist/packages/*.deb out/

      - name: Upload Linux + Windows assets
        uses: actions/upload-artifact@v4
        with:
          name: linux-windows-assets
          path: out/*
          if-no-files-found: error

  build_macos:
    name: Build macOS Assets
    runs-on: macos-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build macOS binaries
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"
          make VERSION="${VERSION}" build PLATFORMS="darwin/amd64 darwin/arm64"

      - name: Build PKG + DMG packages
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"
          make VERSION="${VERSION}" package-macos ARCHES="amd64 arm64"

      - name: Collect macOS assets
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"
          mkdir -p out

          # Portable bundles (binary + web assets).
          tar -C dist -czf "out/mizban-${VERSION}-macos-amd64.tar.gz" "darwin-amd64"
          tar -C dist -czf "out/mizban-${VERSION}-macos-arm64.tar.gz" "darwin-arm64"

          cp dist/packages/*.dmg out/
          cp dist/packages/*.pkg out/

      - name: Upload macOS assets
        uses: actions/upload-artifact@v4
        with:
          name: macos-assets
          path: out/*
          if-no-files-found: error

  build_windows_msi:
    name: Build Windows MSI Assets
    runs-on: windows-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Prepare Windows icon resources
        shell: bash
        run: |
          set -euo pipefail
          go install github.com/akavel/rsrc@latest
          echo "$(go env GOPATH)/bin" >> "${GITHUB_PATH}"
          export PATH="$(go env GOPATH)/bin:${PATH}"
          ./packaging/windows/generate_icon_syso.sh

      - name: Setup WiX v4 CLI
        shell: pwsh
        run: |
          dotnet tool update --global wix --version 4.* 2>$null
          if ($LASTEXITCODE -ne 0) {
            dotnet tool install --global wix --version 4.*
          }
          "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Build Windows binaries for MSI payloads
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"
          for arch in amd64 arm64; do
            out_dir="dist/windows-${arch}"
            mkdir -p "${out_dir}"
            GOOS="windows" GOARCH="${arch}" CGO_ENABLED=0 go build -trimpath -buildvcs=false -ldflags "-s -w -X main.version=${VERSION}" -o "${out_dir}/mizban.exe" ./cmd/mizban
          done

      - name: Build MSI packages
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"
          for arch in amd64 arm64; do
            ./packaging/windows/build_msi.sh "${VERSION}" "${arch}"
          done

      - name: Collect MSI assets
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out
          cp dist/packages/*.msi out/

      - name: Upload Windows MSI assets
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi-assets
          path: out/*
          if-no-files-found: error

  bundle_assets:
    name: Bundle Release Assets
    runs-on: ubuntu-latest
    needs:
      - prepare
      - build_linux_windows
      - build_macos
      - build_windows_msi
    outputs:
      artifact_name: ${{ steps.bundle.outputs.artifact_name }}
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: _artifacts

      - name: Assemble release bundle and checksums
        id: bundle
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"
          OUT="release-assets"

          mkdir -p "${OUT}"
          # Release bundle contains distributable artifacts only.
          find _artifacts -type f \
            \( \
              -name "mizban-${VERSION}-*.tar.gz" -o \
              -name "mizban-${VERSION}-*.deb" -o \
              -name "mizban-${VERSION}-*.dmg" -o \
              -name "mizban-${VERSION}-*.pkg" -o \
              -name "mizban-${VERSION}-*.msi" -o \
              -name "mizban-${VERSION}-*.exe" -o \
              -name "mizban-${VERSION}-linux-amd64" -o \
              -name "mizban-${VERSION}-linux-arm64" \
            \) \
            -exec cp {} "${OUT}" \;

          (
            cd "${OUT}"
            find . -maxdepth 1 -type f ! -name "SHA256SUMS.txt" -print0 | sort -z | xargs -0 sha256sum > SHA256SUMS.txt
          )

          ARTIFACT_NAME="release-assets-${VERSION}"
          echo "artifact_name=${ARTIFACT_NAME}" >> "${GITHUB_OUTPUT}"

      - name: Upload assembled assets
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.bundle.outputs.artifact_name }}
          path: release-assets/*
          if-no-files-found: error

  publish_release:
    name: Publish GitHub Release
    if: needs.prepare.outputs.is_release == 'true'
    runs-on: ubuntu-latest
    needs:
      - prepare
      - bundle_assets
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download release bundle
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.bundle_assets.outputs.artifact_name }}
          path: release-assets

      - name: Create GitHub release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: Mizban ${{ needs.prepare.outputs.tag }}
          body_path: docs/release-notes/${{ needs.prepare.outputs.tag }}.md
          files: release-assets/*
          generate_release_notes: false
